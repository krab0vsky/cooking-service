<div class="recipe-page">
  
  {{!-- –û–±–ª–æ–∂–∫–∞ --}}
  <div class="recipe-cover">
    <img 
      src="{{#if recipe.image}}{{recipe.image}}{{else}}/default_food.jpg{{/if}}" 
      alt="{{recipe.title}}" 
    >
    {{#if recipe.cooking_time}}
      <span class="recipe-time-tag">
        ‚è± {{recipe.cooking_time}} –º–∏–Ω
      </span>
    {{/if}}
  </div>
  
  {{!-- –ö–æ–Ω—Ç–µ–Ω—Ç --}}
  <div class="recipe-content">
    <h1 class="recipe-title">{{recipe.title}}</h1>
    
    <div class="recipe-meta">
      <span class="recipe-author">üë®‚Äçüç≥ {{recipe.author_name}}</span>
    </div>
    
    {{#if categories.length}}
      <div class="recipe-categories">
        {{#each categories}}
          <span class="recipe-category">{{this.name}}</span>
        {{/each}}
      </div>
    {{/if}}
    
    {{#if recipe.description}}
      <div class="recipe-section">
        <h3>–û–ø–∏—Å–∞–Ω–∏–µ</h3>
        <p>{{recipe.description}}</p>
      </div>
    {{/if}}
    
    {{!-- –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã --}}
    <div class="recipe-section">
      <h3>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</h3>
      {{#if recipe.ingredients_text}}
        <pre class="ingredients-box">{{recipe.ingredients_text}}</pre>
      {{else}}
        <p class="muted">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã.</p>
      {{/if}}
    </div>
    
    {{!-- –®–∞–≥–∏ --}}
    {{#if steps.length}}
      <div class="recipe-section">
        <h3>–ü–æ—à–∞–≥–æ–≤–æ–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ</h3>
        <div class="recipe-steps">
          {{#each steps}}
            <div class="recipe-step">
              <div class="step-number">–®–∞–≥ {{this.step_number}}</div>
              <div class="step-text">{{this.text}}</div>
              {{#if this.image}}
                <img 
                  src="{{this.image}}" 
                  alt="–®–∞–≥ {{this.step_number}}" 
                  class="step-image" 
                >
              {{/if}}
            </div>
          {{/each}}
        </div>
      </div>
    {{/if}}
    
    {{!-- –ö–Ω–æ–ø–∫–∏ --}}
    <div class="recipe-actions">
      <a href="/recipes" class="btn btn-outline-secondary">‚Üê –ù–∞–∑–∞–¥</a>
      
      {{#if canEdit}}
        <div class="btn-group">
          <a href="/recipes/{{recipe.id}}/edit" class="btn btn-warning">
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
          </a>
          <a 
            href="/recipes/{{recipe.id}}/delete" 
            class="btn btn-danger" 
            onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç?')"
          >
            –£–¥–∞–ª–∏—Ç—å
          </a>
        </div>
      {{/if}}
    </div>
  </div>
  
  {{!-- –†–ï–ô–¢–ò–ù–ì --}}
  <div class="recipe-section">
    <h3>–†–µ–π—Ç–∏–Ω–≥</h3>
    
    {{#if rating.count}}
      <p class="rating-value">
        ‚≠ê {{rating.avg}} / 5
        <span class="rating-count">({{rating.count}} –æ—Ü–µ–Ω–æ–∫)</span>
      </p>
    {{else}}
      <p class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫</p>
    {{/if}}
    
    {{#if user}}
      {{#unless userRating}}
        {{#unless canEdit}}
          <form method="POST" action="/recipes/{{recipe.id}}/rating" class="review-form">
            <input type="hidden" name="_csrf" value="{{csrfToken}}">
            <label>–í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞</label>
            <select name="rating" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
              <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
              <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
              <option value="3">‚≠ê‚≠ê‚≠ê</option>
              <option value="2">‚≠ê‚≠ê</option>
              <option value="1">‚≠ê</option>
            </select>
            <button class="btn btn-primary">–û—Ü–µ–Ω–∏—Ç—å</button>
          </form>
        {{/unless}}
      {{else}}
        <p class="muted">–í—ã —É–∂–µ –ø–æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ü–µ–Ω–∫—É ‚≠ê {{userRating}}</p>
      {{/unless}}
    {{else}}
      <p class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</p>
    {{/if}}
  </div>
  
  {{!-- –û–¢–ó–´–í --}}
  <div class="recipe-section">
      <h3>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h3>
    
      <form id="reviewForm" method="POST" class="review-form">
          <input type="hidden" name="_csrf" value="{{csrfToken}}">
          {{#unless user}}
              <input 
                  type="text" 
                  name="author_name" 
                  id="author_name"
                  placeholder="–í–∞—à–µ –∏–º—è" 
                  required 
                  class="form-control mb-2"
              >
          {{/unless}}
        
          <textarea 
              name="text" 
              id="reviewText"
              placeholder="–í–∞—à –æ—Ç–∑—ã–≤..." 
              required
              class="form-control mb-2"
              rows="3"
          ></textarea>
        
          <input type="hidden" name="parent_id" id="parent_id" value="">

          <button type="submit" class="btn btn-primary" id="submitReview">
              –û—Ç–ø—Ä–∞–≤–∏—Ç—å
          </button>
          <div id="reviewError" class="text-danger mt-2" style="display: none;"></div>
      </form>
  </div>
  
  {{!-- –°–ü–ò–°–û–ö –û–¢–ó–´–í–û–í --}}
  <div class="recipe-section">
      <h3>–û—Ç–∑—ã–≤—ã <span id="reviewsCount">({{reviews.length}})</span></h3>
    
      <div id="reviewsList" class="reviews-list">
          {{#if reviews.length}}
              {{#each reviews}}
                  <div class="review-card mb-3" id="review-{{this.id}}">
                      <div class="review-header">
                          <strong>
                              {{#if this.user_name}}
                                  {{this.user_name}}
                              {{else}}
                                  {{this.author_name}}
                              {{/if}}
                          </strong>
                          <small class="text-muted ms-2">{{formatDate this.created_at}}</small>
                      </div>

                      <div class="review-text mt-2">{{this.text}}</div>
                  </div>
              {{/each}}
          {{else}}
              <p class="muted" id="noReviews">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
          {{/if}}
      </div>
  </div>

  <script>
document.addEventListener('DOMContentLoaded', function() {
    const reviewForm = document.getElementById('reviewForm');
    const reviewsList = document.getElementById('reviewsList');
    const noReviews = document.getElementById('noReviews');
    const reviewsCount = document.getElementById('reviewsCount');
    const submitBtn = document.getElementById('submitReview');
    const reviewError = document.getElementById('reviewError');
    
    if (reviewForm) {
        reviewForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const recipeId = window.location.pathname.split('/')[2];

            // üîê CSRF token –∏–∑ —Ñ–æ—Ä–º—ã
            const csrfToken = formData.get('_csrf');
            
            const text = document.getElementById('reviewText').value.trim();
            if (!text) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> –û—Ç–ø—Ä–∞–≤–∫–∞...';
            reviewError.style.display = 'none';
            
            try {
                const response = await fetch(`/recipes/${recipeId}/review`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'CSRF-Token': csrfToken // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û
                    },
                    body: new URLSearchParams(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.review) {
                        addNewReview(data.review);
                    } else {
                        const text = document.getElementById('reviewText').value;
                        const authorName = document.getElementById('author_name') 
                            ? document.getElementById('author_name').value 
                            : '{{user.name}}';
        
                        const tempReview = {
                            id: 'temp-' + Date.now(),
                            text: text,
                            user_name: authorName,
                            created_at: new Date().toISOString()
                        };
        
                        addNewReview(tempReview);
                    }
                    
                    reviewForm.reset();
                    showSuccessMessage('–û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
                    updateReviewsCount();
                } else {
                    showError(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–∑—ã–≤–∞');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            }
        });
    }
    
    function addNewReview(review) {
        if (noReviews) {
            noReviews.style.display = 'none';
        }
        
        const reviewHTML = `
            <div class="review-card mb-3" id="review-${review.id}">
                <div class="review-header">
                    <strong>${review.user_name}</strong>
                    <small class="text-muted ms-2">${formatDateForDisplay(review.created_at)}</small>
                </div>
                <div class="review-text mt-2">${review.text}</div>
            </div>
        `;
        
        if (reviewsList.firstChild) {
            reviewsList.insertAdjacentHTML('afterbegin', reviewHTML);
        } else {
            reviewsList.innerHTML = reviewHTML;
        }
        
        const newReview = document.getElementById(`review-${review.id}`);
        newReview.style.opacity = '0';
        newReview.style.transform = 'translateY(-10px)';
        
        setTimeout(() => {
            newReview.style.transition = 'opacity 0.3s, transform 0.3s';
            newReview.style.opacity = '1';
            newReview.style.transform = 'translateY(0)';
        }, 10);
    }
    
    function updateReviewsCount() {
        const reviews = document.querySelectorAll('.review-card');
        if (reviewsCount) {
            reviewsCount.textContent = `(${reviews.length})`;
        }
    }
    
    function showError(message) {
        reviewError.textContent = message;
        reviewError.style.display = 'block';
        setTimeout(() => {
            reviewError.style.display = 'none';
        }, 5000);
    }
    
    function showSuccessMessage(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
        successDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        reviewForm.parentNode.insertBefore(successDiv, reviewForm);
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(successDiv);
            bsAlert.close();
        }, 3000);
    }
    
    function formatDateForDisplay(dateString) {
        if (!dateString) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHour = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHour / 24);
        
        if (diffSec < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        if (diffMin < 60) return `${diffMin} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
        if (diffHour < 24) return `${diffHour} —á. –Ω–∞–∑–∞–¥`;
        if (diffDay < 7) return `${diffDay} –¥–Ω. –Ω–∞–∑–∞–¥`;
        
        return date.toLocaleDateString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    updateReviewsCount();
});
</script>
